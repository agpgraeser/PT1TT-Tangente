<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>PTn-Parameter Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f5f5f5;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            height: 100vh;
        }

        .left-panel {
            background: #ffffff;
            padding: 16px 20px;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
            overflow-y: auto;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            background: #fafafa;
            overflow: hidden;
        }

        #plotArea {
            flex: 1;
            width: 100%;
            height: 100%;
        }

        .panel-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .left-panel .field-row-compact {
            display: grid;
            grid-template-columns: auto 80px auto 80px auto 80px;
            column-gap: 4px;
            row-gap: 4px;
            align-items: center;
            margin-bottom: 8px;
        }

        .left-panel .field-row-single {
            display: grid;
            grid-template-columns: auto 80px;
            column-gap: 4px;
            align-items: center;
            margin-bottom: 8px;
        }

        .left-panel .field-row-compact label,
        .left-panel .field-row-single label {
            font-size: 0.85rem;
            font-weight: 500;
            text-align: left;
            white-space: nowrap;
        }

        .left-panel .field-row-compact input,
        .left-panel .field-row-single input {
            width: 80px;
            padding: 4px 6px;
            font-size: 0.85rem;
            border-radius: 3px;
            border: 1px solid #ccc;
            text-align: right;
            box-sizing: border-box;
        }

        .left-panel input.output {
            background: #e5f7e5;
            border: 1px solid #b2d8b2;
        }

        .invalid {
            background: #ffcccc !important;
            border-color: #ff4444 !important;
        }
    
        .field-row-compact label {
            display: inline-block;
            width: 60px; /* anpassen nach Bedarf */
        }

    
        

    </style>
</head>

<body>


<div class="app-container">

    <!-- Linkes Drittel -->
    <div class="left-panel">

        <!-- PT1TT-Parameter -->
        <div class="section">
            <div class="panel-title">PT1TT-Parameter mit Wendetangente ermitteln</div>

            <div class="field-row-compact">
                <label for="XA">XA</label>
                <input type="number" id="XA" value="0.00" step="0.01">
                <label for="XE">XE</label>
                <input type="number" id="XE" value="1.00" step="0.01">
                <label for="DX">DX</label>
                <input type="number" id="DX" class="output" value="1.00" readonly>
            </div>

            <div class="field-row-compact">
                <label for="YA">YA</label>
                <input type="number" id="YA" value="0.00" step="0.01">

                <label for="YE">YE</label>
                <input type="number" id="YE" value="1.00" step="0.01">

                <label for="DY">DY</label>
                <input type="number" id="DY" class="output" value="1.00" readonly>

            </div>

            <div class="field-row-single">
                <label for="t0">t‚ÇÄ</label>
                <input type="number" id="t0" value="-100.0" step="0.1">
            </div>
        </div>

        <!-- Wendetangenten Methode -->
        <div class="section">
            <div class="panel-title">Wendetangenten Methode f√ºr Mehrspeichersysteme</div>

            <div class="field-row-compact">
                <label for="X1">X1 </label>
                <input type="number" id="X1" value="0.00" step="0.01">

                <label for="t1 ">t1 </label>
                <input type="number" id="t1" value="0.00" step="0.01">

                <div></div><div></div>
            </div>


            <div class="field-row-compact">
                <label for="XWP">XWP</label>
                <input type="number" id="XWP" value="0.00" step="0.01">

                <label for="tWP">tWP</label>
                <input type="number" id="tWP" value="0.00" step="0.01">

                <div></div><div></div>
            </div>

            <div class="field-row-compact">
                <label for="X2">X2</label>
                <input type="number" id="X2" value="0.00" step="0.01">

                <label for="t2">t2</label>
                <input type="number" id="t2" value="0.00" step="0.01">

                <div></div><div></div>
            </div>
        </div>
        <div class="section">
            <div class="panel-title">Kennwerte, K√ºpfm√ºller (TT, TG) & K√ºpfm√ºller korr.(TT1,TG1)</div>

            <div class="field-row-compact">
                <label for="kS">kS</label>
                <input type="number" id="kS" class="output" readonly>

                <label for="TT">TT</label>
                <input type="number" id="TT" class="output" readonly>

                <label for="TG">TG</label>
                <input type="number" id="TG" class="output" readonly>

                <label for="kS">kS1</label>
                <input type="number" id="kS1" class="output" readonly>

                <label for="TT1">TT1</label>
                <input type="number" id="TT1" class="output" readonly>

                <label for="TG1">TG1</label>
                <input type="number" id="TG1" class="output" readonly>

            </div>
        </div>

        

        <div class="section">
            <div class="panel-title">Messdaten laden</div>

            <input type="file" id="excelFile" accept=".xlsx,.xls" />
            <div id="fileInfo" style="font-size:0.8rem; color:#555; margin-top:6px;"></div>
        </div>

        <!-- Weitere Einstellungen -->
        <div class="section">
            <div class="panel-title">Weitere Einstellungen (Platzhalter)</div>
            <div id="excelPreview" style="font-size:0.85rem; color:#333; margin-top:8px;"></div>
        </div>
    </div> <!-- Ende left-panel -->

    <!-- Rechtes Zweidrittel -->
    <div class="right-panel">
    <div id="plotArea" style="width:100%; height:100%;"></div>

    </div>




</div>
<!-- ========================= -->
<!-- 1) Externe Bibliotheken -->
<!-- ========================= -->
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
console.log("JS geladen");
/* ---------------------------------------------------------
   Globale Variablen
--------------------------------------------------------- */
let loadedFilename = "";


/* ---------------------------------------------------------
   DOM-Referenzen
--------------------------------------------------------- */
const XA = document.getElementById("XA");
const XE = document.getElementById("XE");
const DX = document.getElementById("DX");

const YA = document.getElementById("YA");
const YE = document.getElementById("YE");
const DY = document.getElementById("DY");


const t0  = document.getElementById("t0");
const t1 = document.getElementById("t1");
const tWP = document.getElementById("tWP");
const t2 = document.getElementById("t2");

const X1 = document.getElementById("X1");
const XWP = document.getElementById("XWP");
const X2 = document.getElementById("X2");

const kS  = document.getElementById("kS");
const TT  = document.getElementById("TT");
const TG  = document.getElementById("TG");

const kS1 = document.getElementById("kS1");
const TT1 = document.getElementById("TT1");
const TG1 = document.getElementById("TG1");

const excelInput = document.getElementById("excelFile");
const fileInfo   = document.getElementById("fileInfo");

/* ---------------------------------------------------------
   Datencontainer f√ºr Excel
--------------------------------------------------------- */
let timeData = [];
let xData = [];
let yData = [];
let systemName = "";
let varNames = {};
let units = {};
let fileName = "";

/* ---------------------------------------------------------
   Hilfsfunktionen
--------------------------------------------------------- */
function isValidNumber(el) {
    if (!el) return false;
    const v = parseFloat(el.value);
    return !(isNaN(v) || !isFinite(v));
}

function updateFieldStyle(el) {
    if (!el) return;
    if (isValidNumber(el)) el.classList.remove("invalid");
    else el.classList.add("invalid");
}

/* ---------------------------------------------------------
   DX = XE - XA
--------------------------------------------------------- */
function updateDX() {
    updateFieldStyle(XA);
    updateFieldStyle(XE);

    if (isValidNumber(XA) && isValidNumber(XE)) {
        const xa = parseFloat(XA.value);
        const xe = parseFloat(XE.value);
        DX.value = (xe - xa).toFixed(2);
        //updateXvalues();//
    } else {
        DX.value = "";
        X1.value = "";
        XWP.value = "";
        X2.value = "";
    }

    updateDerivedValues();
}

/* ---------------------------------------------------------
   DY = YE - YA
--------------------------------------------------------- */
function updateDY() {
    updateFieldStyle(YA);
    updateFieldStyle(YE);

    if (isValidNumber(YA) && isValidNumber(YE)) {
        const ya = parseFloat(YA.value);
        const ye = parseFloat(YE.value);
        DY.value = (ye - ya).toFixed(2);
    } else {
        DY.value = "";
    }

    updateDerivedValues();
}


/* ---------------------------------------------------------
   X10/X50/X90 berechnen
--------------------------------------------------------- */
function updateXvalues() {
    if (!isValidNumber(XA) || !isValidNumber(DX)) {
        X1.value = "";
        XWP.value = "";
        X2.value = "";
        return;
    }

    const xa = parseFloat(XA.value);
    const dx = parseFloat(DX.value);

    /*X10.value = (xa + 0.1 * dx).toFixed(2);
    X50.value = (xa + 0.5 * dx).toFixed(2);
    X90.value = (xa + 0.9 * dx).toFixed(2);*/
}

/* ---------------------------------------------------------
   Zeitvalidierung
--------------------------------------------------------- */
function updateTimeOrder() {
    updateFieldStyle(t0);
    updateFieldStyle(t1);
    updateFieldStyle(tWP);
    updateFieldStyle(t2);

    if (!isValidNumber(t0) || !isValidNumber(t1) || !isValidNumber(tWP) || !isValidNumber(t2))
        return;

    const t0v  = parseFloat(t0.value);
    const t1v = parseFloat(t1.value);
    const tWPv = parseFloat(tWP.value);
    const t2v = parseFloat(t2.value);

    // üî¥ Pr√ºfung: t0 >= 0
    if (t0v < 0) {
        t0.classList.add("invalid");
    }

    // üî¥ Pr√ºfung: t1 > t0
    if (t1v <= t0v) t1.classList.add("invalid");

    // üî¥ Pr√ºfung: tWP > t0
    if (tWPv <= t0v) tWP.classList.add("invalid");

    // üî¥ Pr√ºfung: t2 > t0
    if (t2v <= t0v) t2.classList.add("invalid");

    // üî¥ Pr√ºfung: t1 < tWP
    if (!(t1v < tWPv)) {
        t1.classList.add("invalid");
        tWP.classList.add("invalid");
    }

    // üî¥ Pr√ºfung: tWP < t2
    if (!(tWPv < t2v)) {
        tWP.classList.add("invalid");
        t2.classList.add("invalid");
    }

    updateDerivedValues();
}


/* ---------------------------------------------------------
   Relative Zeiten + kS, TT, TG
--------------------------------------------------------- */
function updateDerivedValues() {
    if (!isValidNumber(t0) || !isValidNumber(t1) || !isValidNumber(tWP) || !isValidNumber(t2)) {
        kS.value = "";
        TT.value = "";
        TG.value = "";
        kS1.value = "";
        TT1.value = "";
        TG1.value = "";
        return;
    }

    const t0v  = parseFloat(t0.value);
    const t1v = parseFloat(t1.value);
    const tWPv = parseFloat(tWP.value);
    const t2v = parseFloat(t2.value);

    const t1_rel = t1v - t0v;
    const tWP_rel = tWPv - t0v;
    const t2_rel = t2v - t0v;

    if (isValidNumber(DX) && isValidNumber(DY) && parseFloat(DY.value) !== 0) {
        kS.value = (parseFloat(DX.value) / parseFloat(DY.value)).toFixed(4);
        kS1.value = (parseFloat(DX.value) / parseFloat(DY.value)).toFixed(4);
    } else {
        kS.value = "";
        kS1.value = "";
    }


    TT.value = t1_rel ;
    const tt = parseFloat(TT.value);
    const t1_corr = t1_rel - tt;
    const tWP_corr = tWP_rel - tt;
    const t2_corr = t2_rel - tt;
    TG.value = t2_corr - t1_corr;
    TG1.value = t2_corr - tWP_corr;
}

/* ---------------------------------------------------------
   Modellantwort (PT1TT)
--------------------------------------------------------- */
function computeModelResponse() {
    const XM = [];

    const xa = parseFloat(XA.value);
    const dy = parseFloat(DY.value);
    const ks = parseFloat(kS.value);
    const tt = parseFloat(TT.value);
    const tg = parseFloat(TG.value);
    const t0v = parseFloat(t0.value);

    const tDelay = t0v + tt;

    for (let i = 0; i < timeData.length; i++) {
        const t = timeData[i];

        if (t <= tDelay) {
            XM.push(xa);
        } else {
            const exponent = -(t - tDelay) / tg;
            XM.push(xa + ks * dy * (1 - Math.exp(exponent)));
        }
    }

    return XM;
}

/* ---------------------------------------------------------
   Excel einlesen
--------------------------------------------------------- */
excelInput.addEventListener("change", handleExcelFile);

function handleExcelFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    fileName = file.name.replace(/\.[^/.]+$/, "");
    loadedFilename = file.name;

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        parseExcelStructure(rows);
        fileInfo.innerText = "Geladen: " + file.name;
        showFirstThreeRows(rows);
        plotData();
    };

    reader.readAsArrayBuffer(file);
}

/* ---------------------------------------------------------
   Struktur A/B/C erkennen
   und Daten in timeData, xData, yData ablegen
--------------------------------------------------------- */
function parseExcelStructure(rows) {
    timeData = [];
    xData = [];   // 
    yData = [];   // 

    const first = rows[0];
    const second = rows[1];
    const third = rows[2];

    // Struktur C: 3 Kopfzeilen (Name, Variablen, Einheiten)
    const isC =
        first && typeof first[0] === "string" &&
        second && typeof second[0] === "string" &&
        third;

    if (isC) {
        systemName = first[0];

        varNames.time = second[0] || "Zeit";
        varNames.x    = second[1] || "X";   // Ausgang
        varNames.y    = second[2] || "Y";   // Eingang

        units.time = third[0] || "";
        units.x    = third[1] || "";
        units.y    = third[2] || "";

        for (let i = 3; i < rows.length; i++) {
            const r = rows[i];
            if (!r || r.length < 2) continue;

            timeData.push(r[0]);
            xData.push(r[1]);       // Ausgang
            if (r.length >= 3) yData.push(r[2]);  // Eingang
        }
        return;
    }

    /* ---------------------------------------------------------
       Struktur A/B: 1 Kopfzeile oder keine
       Spalten: Zeit | X | Y?
    --------------------------------------------------------- */
    const hasY = rows[0] && rows[0].length >= 3;

    for (let i = 0; i < rows.length; i++) {
        const r = rows[i];
        if (!r || r.length < 2) continue;

        timeData.push(r[0]);
        xData.push(r[1]);          // Ausgang
        if (hasY) yData.push(r[2]); // Eingang
    }

    systemName = fileName;

    varNames = {
        time: "Zeit",
        x: "X",
        y: hasY ? "Y" : null
    };

    units = {
        time: "",
        x: "",
        y: ""
    };
}

/* ---------------------------------------------------------
   Show first three rows of the raw Excel input in the UI
--------------------------------------------------------- */
function showFirstThreeRows(rows) {
    const preview = document.getElementById("excelPreview");
    if (!preview) return;

    const firstRows = (rows || []).slice(0, 3);
    if (firstRows.length === 0) {
        preview.innerText = "Keine Vorschau verf√ºgbar.";
        return;
    }

    let html = '<table style="border-collapse:collapse; width:100%;">';
    for (let r = 0; r < firstRows.length; r++) {
        const row = firstRows[r] || [];
        html += '<tr>';
        for (let c = 0; c < row.length; c++) {
            const cell = row[c] !== undefined ? String(row[c]) : '';
            html += '<td style="border:1px solid #e6e6e6; padding:6px; font-size:0.85rem;">' + cell + '</td>';
        }
        html += '</tr>';
    }
    html += '</table>';
    preview.innerHTML = html;
}


/* ---------------------------------------------------------
   Plot-Funktion
--------------------------------------------------------- */
function computeMinMax(arr) {
    if (!arr || arr.length === 0) {
        return { min: null, max: null };
    }
    return {
        min: Math.min(...arr),
        max: Math.max(...arr)
    };
}



function plotData() {
    if (timeData.length === 0) return;

    /* ---------------------------------------------------------
       1) Min/Max berechnen
    --------------------------------------------------------- */
    const timeStats = computeMinMax(timeData);
    const xStats    = computeMinMax(xData);
    const yStats    = computeMinMax(yData);

    const tMin = timeStats.min;
    const tMax = timeStats.max;
    const xMin = xStats.min;
    const xMax = xStats.max;
    const yMin = yStats.min;
    const yMax = yStats.max;

    /* ---------------------------------------------------------
       2) Modellantwort berechnen
    --------------------------------------------------------- */
    const XM = computeModelResponse();

    /* ---------------------------------------------------------
       3) Plot-Traces
    --------------------------------------------------------- */
    const traceX = {
        x: timeData,
        y: xData,
        mode: "lines",
        name: "Messwert X",
        line: { width: 2, color: "blue" },
        xaxis: "x1",
        yaxis: "y1"
    };

    const traceY = {
        x: timeData,
        y: yData,
        mode: "lines",
        name: "Eingang Y",
        line: { width: 2, color: "red" },
        xaxis: "x2",
        yaxis: "y2"
    };

    const traceModel = {
        x: timeData,
        y: XM,
        mode: "lines",
        name: "Modellantwort",
        line: { width: 4, color: "red", dash: "dot" },
        xaxis: "x1",
        yaxis: "y1"
    };

    /* ---------------------------------------------------------
       4) Parameter aus UI lesen
    --------------------------------------------------------- */
    const t0v  = parseFloat(t0.value);
    const t1v = parseFloat(t1.value);
    const tWPv = parseFloat(tWP.value);
    const t2v = parseFloat(t2.value);

    const X1v = parseFloat(X1.value);
    const XWPv = parseFloat(XWP.value);
    const X2v = parseFloat(X2.value);

    const xa = parseFloat(XA.value);
    const xe = parseFloat(XE.value);

    /* ---------------------------------------------------------
       5) Shapes definieren (JETZT ist tMin/tMax verf√ºgbar!)
    --------------------------------------------------------- */
    const shapes = [

        // vertikale Linie t0
        {
            type: "line",
            x0: t0v,
            x1: t0v,
            y0: xe,
            y1: xa,
            xref: "x1",
            yref: "y1",
            line: { color: "orange", width: 2, dash: "dot" }
        },

        // horizontale Linien XA / XE
        {
            type: "line",
            x0: tMin,
            x1: tMax,
            y0: xa,
            y1: xa,
            xref: "x1",
            yref: "y1",
            line: { color: "red", width: 2, dash: "dash" }
        },
        {
            type: "line",
            x0: tMin,
            x1: tMax,
            y0: xe,
            y1: xe,
            xref: "x1",
            yref: "y1",
            line: { color: "red", width: 2, dash: "dash" }
        },

        // horizontale Linien X10 / X50 / X90
        {
            type: "line",
            x0: tMin,
            x1: t1v,
            y0: X1v,
            y1: X1v,
            xref: "x1",
            yref: "y1",
            line: { color: "green", width: 1, dash: "dash" }
        },
        {
            type: "line",
            x0: tMin,
            x1: tWPv,
            y0: XWPv,
            y1: XWPv,
            xref: "x1",
            yref: "y1",
            line: { color: "green", width: 1, dash: "dash" }
        },
        {
            type: "line",
            x0: tMin,
            x1: t2v,
            y0: X2v,
            y1: X2v,
            xref: "x1",
            yref: "y1",
            line: { color: "green", width: 1, dash: "dash" }
        },

        // vertikale Linien t10 / t50 / t90
        {
            type: "line",
            x0: t1v,
            x1: t1v,
            y0: xa,
            y1: X1v,
            xref: "x1",
            yref: "y1",
            line: { color: "green", width: 1, dash: "dash" }
        },
        {
            type: "line",
            x0: tWPv,
            x1: tWPv,
            y0: xa,
            y1: XWPv,
            xref: "x1",
            yref: "y1",
            line: { color: "green", width: 1, dash: "dash" }
        },
        {
            type: "line",
            x0: t2v,
            x1: t2v,
            y0: xa,
            y1: X2v,
            xref: "x1",
            yref: "y1",
            line: { color: "green", width: 1, dash: "dash" }
        }
    ];

    /* ---------------------------------------------------------
       6) Annotations (nur oberes Diagramm)
    --------------------------------------------------------- */
    const annotations = [
        {
            x: t0v,
            y: xa,
            xref: "x1",
            yref: "y1",
            text: "t0",
            showarrow: false,
            yshift: -20,
            font: { size: 12, color: "red" }
        },
        {
            x: t1v,
            y: xa,
            xref: "x1",
            yref: "y1",
            text: "t1",
            showarrow: false,
            yshift: -20,
            font: { size: 12, color: "blue" }
        },
        {
            x: tWPv,
            y: xa,
            xref: "x1",
            yref: "y1",
            text: "tWP",
            showarrow: false,
            yshift: -20,
            font: { size: 12, color: "blue" }
        },
        {
            x: t2v,
            y: xa,
            xref: "x1",
            yref: "y1",
            text: "t2",
            showarrow: false,
            yshift: -20,
            font: { size: 12, color: "blue" }
        }
    ];

    /* ---------------------------------------------------------
       7) Plot erzeugen (Subplots)
    --------------------------------------------------------- */
    Plotly.newPlot("plotArea", [traceX, traceY, traceModel], {

    title: {
        text: loadedFilename ? ("Datei: " + loadedFilename) : "PT1TT ‚Äì Zeitverl√§ufe",
        y: 0.95,
        pad: { t: 10 }
    },

    grid: {
        rows: 2,
        columns: 1,
        roworder: "top to bottom",
        heights: [0.67, 0.33],
        pattern: "independent",
        ygap: 0.02
    },

    // oberes Diagramm
    xaxis:  { title: "Zeit" },
    yaxis:  { title: "x(t)" },

    // unteres Diagramm
    xaxis2: { title: "Zeit" },
    yaxis2: { title: "y(t)" },

    shapes: shapes,
    annotations: annotations,

    margin: { t: 60, r: 20, b: 40, l: 50 }
});
}


/* ---------------------------------------------------------
   Event‚ÄëListener
--------------------------------------------------------- */
XA.addEventListener("input", () => { updateDX(); plotData(); });
XE.addEventListener("input", () => { updateDX(); plotData(); });

YA.addEventListener("input", () => { updateDY(); plotData(); });
YE.addEventListener("input", () => { updateDY(); plotData(); });


t0.addEventListener("input", () => { updateTimeOrder(); plotData(); });
t1.addEventListener("input", () => { updateTimeOrder(); plotData(); });
tWP.addEventListener("input", () => { updateTimeOrder(); plotData(); });
t2.addEventListener("input", () => { updateTimeOrder(); plotData(); });

/* ---------------------------------------------------------
   Initiale Berechnung + Plot
--------------------------------------------------------- */
updateDX();
updateDY();
updateXvalues();
updateTimeOrder();
updateDerivedValues();
plotData();

</script>



</body>
</html>
